#_                   _ _ _  _ _____ _  _
#| | _______   ____ _| | | || |___  | || |
#| |/ / _ \ \ / / _` | | | || |_ / /| || |_
#|   <  __/\ V / (_| | | |__   _/ / |__   _|
#|_|\_\___| \_/ \__,_|_|_|  |_|/_/     |_|

#Maintainer: kevall474 <kevall474@tuta.io> <https://github.com/kevall474>
#Credits: Bart≈Çomiej Piotrowski <bpiotrowski@archlinux.org>
#Credits: Allan McRae <allan@archlinux.org>

# toolchain build order: linux-api-headers->glibc->binutils->gcc->binutils->glibc

pkgname=linux-api-headers-git
pkgver=5.12
pkgrel=1
pkgdesc='Kernel headers sanitized for use in userspace'
arch=('i686' 'x86_64')
url='https://www.gnu.org/software/libc'
license=(GPL2)
makedepends=('rsync')
conflicts=('linux-api-headers')
provides=("linux-api-headers=$pkgver" "linux-api-headers")

# remove linux github source from source add do a git clone --depth=1 for fast cloning

prepare(){
  
  if ! dir linux; then
    git clone --depth=1 https://github.com/torvalds/linux.git
  fi
}

pkgver(){
  cd linux
  echo 5.12.$(date -I | sed 's/-/_/' | sed 's/-/_/').$(git rev-list --count HEAD).$(git rev-parse --short HEAD)
}

build(){
  cd linux

  make -j$(nproc) clean
  make -j$(nproc) mrproper
  make -j$(nproc) headers_check
}

package(){
  cd linux

  make -j$(nproc) INSTALL_HDR_PATH="$pkgdir/usr" headers_install

  # use headers from libdrm
  rm -r "$pkgdir/usr/include/drm"
}
